---
services:
  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    ports:
      - "8080:8080"
    volumes:
      - ${DOCKER_CONFIG_ROOT}/open-webui:/app/backend/data
    environment:
      # Ollama Integration
      - OLLAMA_BASE_URL=http://host.docker.internal:11434/

      # SearXNG Search Integration
      - ENABLE_RAG_WEB_SEARCH=True
      - RAG_WEB_SEARCH_ENGINE="searxng"
      - RAG_WEB_SEARCH_RESULT_COUNT=3
      - RAG_WEB_SEARCH_CONCURRENT_REQUESTS=10
      - SEARXNG_QUERY_URL=http://host.docker.internal:8081/search?q=<query>
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: 4G
    cpus: "4.0"

  wyoming-whisper:
    image: rhasspy/wyoming-whisper:latest
    container_name: wyoming-whisper
    command: --model base --language en
    ports:
      - "10300:10300"
    volumes:
      - ${DOCKER_CONFIG_ROOT}/wyoming-whisper:/data
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: 1G
    cpus: "1.0"

  wyoming-piper:
    image: rhasspy/wyoming-piper:latest
    container_name: wyoming-piper
    command: --voice en_US-amy-medium
    ports:
      - "10200:10200"
    volumes:
      - ${DOCKER_CONFIG_ROOT}/wyoming-piper:/data
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: 1G
    cpus: "1.0"

  wyoming-openwakeword:
    image: rhasspy/wyoming-openwakeword:latest
    container_name: wyoming-openwakeword
    command: --preload-model hey_jarvis # alexa & snowboy are other options
    ports:
      - "10400:10400"
    volumes:
      - ${DOCKER_CONFIG_ROOT}/wyoming-openwakeword:/data
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: 512M
    cpus: "1.0"

  n8n:
    image: n8nio/n8n:latest
    container_name: n8n
    ports:
      - "5678:5678"
    volumes:
      - ${DOCKER_CONFIG_ROOT}/n8n:/home/node/.n8n
      - ${OBSIDIAN_VAULT}:/data/obsidian-vault
    environment:
      # Server Configuration
      - N8N_HOST=localhost
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - N8N_SECURE_COOKIE=false

      # Webhook Configuration
      - WEBHOOK_URL=http://host.docker.internal:5678/

      # Task Runner Configuration
      - N8N_RUNNERS_TASK_REQUEST_TIMEOUT=300000
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: 2G
    cpus: "2.0"

  searxng:
    image: searxng/searxng:latest
    container_name: searxng
    ports:
      - "8081:8080"
    volumes:
      - ${DOCKER_CONFIG_ROOT}/searxng:/etc/searxng:rw
    restart: unless-stopped
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - DAC_OVERRIDE
    logging:
      driver: "json-file"
      options:
        max-size: "1m"
        max-file: "1"
    mem_limit: 512M
    cpus: "1.0"

  metube:
    image: ghcr.io/alexta69/metube
    container_name: metube
    ports:
      - "8082:8081"
    volumes:
      - ${DOCKER_CONFIG_ROOT}/metube:/data
      - ${DOCKER_DOWNLOADS_ROOT}:/downloads
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: 1G
    cpus: "1.0"

  # KARAKEEP - Replaces Linkwarden
  karakeep-meilisearch:
    image: getmeili/meilisearch:v1.13.3
    container_name: karakeep-meilisearch
    env_file:
      - env/.env.karakeep
    environment:
      - MEILI_NO_ANALYTICS=true
    volumes:
      - ${DOCKER_CONFIG_ROOT}/karakeep/meili_data:/meili_data
    networks:
      default:
        aliases:
          - meilisearch
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: 512M
    cpus: "1.0"

  karakeep-chrome:
    image: gcr.io/zenika-hub/alpine-chrome:124
    container_name: karakeep-chrome
    restart: unless-stopped
    command:
      - --no-sandbox
      - --disable-gpu
      - --disable-dev-shm-usage
      - --remote-debugging-address=0.0.0.0
      - --remote-debugging-port=9222
      - --hide-scrollbars
    networks:
      default:
        aliases:
          - chrome
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: 512M
    cpus: "1.0"

  karakeep:
    image: ghcr.io/karakeep-app/karakeep:release
    container_name: karakeep
    env_file:
      - env/.env.karakeep
    ports:
      - "3000:3000"
    volumes:
      - ${DOCKER_CONFIG_ROOT}/karakeep/data:/data
    environment:
      - DATA_DIR=/data
      - MEILI_ADDR=http://meilisearch:7700
      - BROWSER_WEB_URL=http://chrome:9222
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      - karakeep-meilisearch
      - karakeep-chrome
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: 1G
    cpus: "2.0"

  budget-dashboard:
    build: ${CODING_ROOT}/python-budget-tracker
    container_name: budget-dashboard
    ports:
      - "8501:8501"
    volumes:
      - ${DOCKER_CONFIG_ROOT}/budget-dashboard/app-data:/app/data
    environment:
      - DATA_FILE_PATH=/app/data/budget_data.json
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8501/_stcore/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: 512M
    cpus: "1.0"

  # budget-dashboard-gf:
  #   build: ${CODING_ROOT}/python-budget-tracker
  #   container_name: budget-dashboard-gf
  #   env_file: env/.env
  #   ports:
  #     - "8504:8501"
  #   volumes:
  #     - ${DOCKER_CONFIG_ROOT}/budget-dashboard-gf/app-data:/app/data
  #   environment:
  #     - DATA_FILE_PATH=/app/data/budget_data.json
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD-SHELL", "curl -f http://localhost:8501/_stcore/health || exit 1"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 30s
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "10m"
  #       max-file: "3"
  #   mem_limit: 512M
  #   cpus: "1.0"

  gitea:
    image: gitea/gitea:1.24.6
    container_name: gitea
    ports:
      - "3002:3000"  # Web UI
      - "2222:22"    # SSH
    volumes:
      - ${DOCKER_CONFIG_ROOT}/gitea:/data
    environment:
      - USER_UID=501
      - USER_GID=20
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/ || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: 1G
    cpus: "2.0"

  learning-dashboard:
    build: ${CODING_ROOT}/python-learning-dashboard
    container_name: learning-dashboard
    ports:
      - "8502:8501"
    volumes:
      - ${DOCKER_CONFIG_ROOT}/learning-dashboard/app-data:/app/data
    environment:
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8501/_stcore/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: 512M
    cpus: "1.0"

  audiobookshelf:
    image: ghcr.io/advplyr/audiobookshelf:latest
    container_name: audiobookshelf
    ports:
      - "13378:80"
    volumes:
      - ${DOCKER_CONFIG_ROOT}/audiobookshelf/audiobooks:/audiobooks
      - ${DOCKER_CONFIG_ROOT}/audiobookshelf/podcasts:/podcasts
      - ${DOCKER_CONFIG_ROOT}/audiobookshelf/config:/config
      - ${DOCKER_CONFIG_ROOT}/audiobookshelf/metadata:/metadata
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: 1G
    cpus: "2.0"

  youtube-transcripts-api:
    build: ${CODING_ROOT}/youtube-transcripts-api
    container_name: youtube-transcripts-api
    ports:
      - "5001:5000"
    environment:
      - PYTHONUNBUFFERED=1
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "python3 -c \"import urllib.request; urllib.request.urlopen('http://localhost:5000/health')\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: 512M
    cpus: "1.0"

  open-notebook:
    image: lfnovo/open_notebook:v1-latest-single
    container_name: open-notebook
    env_file:
      - env/.env.open-notebook
    ports:
      - "8503:8502"  # Web UI (mapped to 8503 to avoid conflict with learning-dashboard)
      - "5055:5055"  # API (required!)
    volumes:
      - ${DOCKER_CONFIG_ROOT}/open-notebook/notebook_data:/app/data
      - ${DOCKER_CONFIG_ROOT}/open-notebook/surreal_single_data:/mydata
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:5055/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: 2G
    cpus: "2.0"

  openedai-speech:
    image: ghcr.io/matatonic/openedai-speech:latest
    container_name: openedai-speech
    env_file:
      - env/.env.openedai-speech
    ports:
      - "8000:8000"  # TTS API
    volumes:
      - ${DOCKER_CONFIG_ROOT}/openedai-speech/voices:/app/voices
      - ${DOCKER_CONFIG_ROOT}/openedai-speech/config:/app/config
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8000/v1/models || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 180s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: 8G
    cpus: "4.0"

  tailscale:
    image: tailscale/tailscale:latest
    container_name: tailscale
    env_file:
      - env/.env.tailscale
    hostname: homelab-docker
    environment:
      - TS_STATE_DIR=/var/lib/tailscale
      - TS_USERSPACE=true
    volumes:
      - ${DOCKER_CONFIG_ROOT}/tailscale/state:/var/lib/tailscale
    cap_add:
      - NET_ADMIN
      - NET_RAW
    network_mode: host
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: 256M
    cpus: "0.5"

  alpine-utility:
    build: ./alpine-utility
    container_name: alpine-utility
    hostname: alpine-utility
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${DOCKER_CONFIG_ROOT}/alpine-utility:/config
      - ${HOMELAB_ROOT}/alpine-utility/scripts:/scripts
      - ${DOCKER_CONFIG_ROOT}/audiobookshelf/podcasts:/mnt/audiobookshelf
      # Budget export script volumes
      - ${DOCKER_CONFIG_ROOT}/budget-dashboard/app-data:/mnt/budget-dashboard:ro
      - ${DOCKER_CONFIG_ROOT}/budget-dashboard-gf/app-data:/mnt/budget-dashboard-gf:ro
      - ${BACKUPS_ROOT}/budget-dashboard:/mnt/backups/budget-dashboard
      # Obsidian vault for monthly summary generation
      - ${OBSIDIAN_VAULT}:/mnt/obsidian-vault
      # Karakeep backup volumes
      - ${DOCKER_CONFIG_ROOT}/karakeep/data:/mnt/karakeep:ro
      - ${BACKUPS_ROOT}/karakeep:/mnt/backups/karakeep
      # Gitea backup volumes
      - ${DOCKER_CONFIG_ROOT}/gitea:/mnt/gitea:ro
      - ${BACKUPS_ROOT}/gitea:/mnt/backups/gitea
    ports:
      - "2223:22"
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: 128M
    cpus: "0.5"

  victoria-logs:
    image: docker.io/victoriametrics/victoria-logs:v0.41.0-victorialogs
    container_name: victoria-logs
    ports:
      - "9428:9428"
    volumes:
      - ${DOCKER_CONFIG_ROOT}/victoria-logs:/victoria-logs-data
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
    command:
      - -storageDataPath=/victoria-logs-data
      - -retentionPeriod=7d
      - -loggerLevel=INFO
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://127.0.0.1:9428/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: 1G
    cpus: "2.0"

  fluent-bit:
    image: fluent/fluent-bit:latest
    container_name: fluent-bit
    ports:
      - "5140:5140/udp"
    volumes:
      - /Users/bud/home_space/homelab/logging/fluent-bit/fluent-bit.conf:/fluent-bit/etc/fluent-bit.conf:ro
      - /Users/bud/home_space/homelab/logging/fluent-bit/parsers.conf:/fluent-bit/etc/custom-parsers.conf:ro
    depends_on:
      - victoria-logs
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    mem_limit: 256M
    cpus: "0.5"
